# TickerOneStock

TickerOneStock 是一个基于 Chrome 扩展 Manifest V3 打造的实时行情小组件，
用于在任何浏览页面里通过悬浮气泡的方式持续追踪单只股票（或指数）的最新价格与涨跌表现。
本项目目前以新浪/腾讯行情接口为数据源，提供轻量但清晰的架构示例，便于继续扩展更多功能。

## ✨ 功能概览

- **实时行情气泡**：在任意打开的标签页注入悬浮气泡，展示实时价格、涨跌幅等核心信息。
- **可配置刷新策略**：统一由后台 Service Worker 轮询行情源，避免多标签页重复拉取。
- **灵活的显示样式**：支持在选项页自定义显示内容（仅价格、仅涨幅或二者同时）、透明度、气泡尺寸与位置。
- **状态同步**：使用 `chrome.storage.sync` 与 `chrome.storage.local` 区分存储配置、缓存与 UI 状态，实现多设备同步与快速加载。
- **扩展性良好的架构**：将数据获取、逻辑处理、UI 展示解耦，方便后续替换数据源或接入更多图表能力。

## 🧱 高层架构与数据流

```
┌────────────────────────────────────────┐
│            Background (Service Worker) │
│  - 定时根据策略轮询行情源（新浪/腾讯）        │
│  - 解析原始数据，统一计算价格、昨收、涨跌幅     │
│  - 根据涨跌幅决定颜色等 UI 标记               │
│  - 通过 chrome.runtime.sendMessage 广播给标签页 │
└────────────────────────────────────────┘
              ▲                     │
              │                     │
              │                     ▼
┌────────────────────────────────────────┐
│            Content Script              │
│  - 注入可拖拽、可折叠的悬浮气泡               │
│  - 订阅 Background 推送的实时数据            │
│  - 更新 DOM，展示价格/涨幅/时间戳            │
│  - 将用户交互状态写入 chrome.storage.local    │
└────────────────────────────────────────┘
              ▲                     │
              │                     │
              │                     ▼
┌────────────────────────────────────────┐
│               Options Page             │
│  - 提供 symbol、刷新周期、显示样式等配置        │
│  - 调整气泡位置/大小/透明度                  │
│  - 将配置写入 chrome.storage.sync，触发刷新      │
└────────────────────────────────────────┘
```

### 关键数据流说明

1. **配置加载**：
   - 浏览器启动或扩展安装时，Background 读取 `chrome.storage.sync` 中的用户配置（股票代码、刷新间隔、显示模式等）。
   - 若无配置，则写入一套默认值。

2. **行情轮询**：
   - Background 按配置周期从行情源（例如新浪 `https://hq.sinajs.cn/list=...` 或腾讯 `https://qt.gtimg.cn/q=...`）拉取数据。
   - 解析接口返回，得到最新价、昨收、时间戳等指标。
   - 根据涨跌幅计算颜色（如涨为红、跌为绿，可配置）。
   - 将最新数据与计算结果缓存至 `chrome.storage.local`，方便 Content Script 首次加载时直接读取。

3. **内容脚本展示**：
   - 每个激活的标签页会注入 Content Script，初始化悬浮气泡 UI。
   - 首次渲染时会从 `chrome.storage.local` 中读取上次缓存的数据，立即展示。
   - 同时订阅来自 Background 的消息，在价格更新时动态刷新显示。
   - 用户拖拽、折叠、隐藏等操作会立刻写回到 `chrome.storage.local`，供下次打开页面时恢复状态。

4. **选项页配置**：
   - 用户在 Options 页面调整参数（如 symbol、刷新周期、显示样式等）。
   - 表单保存后写入 `chrome.storage.sync`，并向 Background 发送配置更新通知。
   - Background 收到通知后重新加载配置并更新轮询逻辑。

## 🗄️ 存储策略

| 存储区域              | 作用范围                         | 典型字段示例                                   |
| --------------------- | -------------------------------- | ---------------------------------------------- |
| `chrome.storage.sync` | 在登录同一账号的设备之间同步       | `symbol`、`refreshInterval`、`displayMode`、`theme` |
| `chrome.storage.local`| 当前设备本地缓存，不会跨设备同步 | `lastQuote`、`previousClose`、`bubbleState`（折叠、位置、尺寸） |

这种划分确保了：
- 配置项跨设备保持一致。
- 实时行情、坐标等高频或本地化状态不会频繁触发同步配额限制。

## ⚙️ 配置项一览

| 配置项                | 类型 / 范围                         | 说明 |
| --------------------- | ------------------------------------ | ---- |
| `symbol`              | 字符串（如 `sz000001`、`sh000300`）   | 要追踪的股票/指数代码，需符合行情源格式。 |
| `refreshInterval`     | 数值（单位：秒，建议 ≥ 3s）           | 后台轮询行情接口的间隔。 |
| `displayMode`         | 枚举：`price` / `change` / `both`    | 控制气泡内显示内容。 |
| `bubblePosition`      | `{ x: number, y: number }`           | 悬浮气泡左上角相对于视口的坐标。 |
| `bubbleSize`          | `{ width: number, height: number }`  | 气泡尺寸，可用于切换紧凑或信息密度更高的布局。 |
| `bubbleOpacity`       | `0 ~ 1`                              | 气泡透明度，用于平衡可视性与干扰度。 |
| `collapsed`           | 布尔值                               | 是否折叠气泡，仅本地存储。 |

## 🛠️ 开发与调试指南

1. **克隆项目**
   ```bash
   git clone https://github.com/<your-account>/TickerOneStock.git
   cd TickerOneStock
   ```

2. **加载至 Chrome**
   1. 访问 `chrome://extensions/`。
   2. 打开右上角「开发者模式」。
   3. 点击「加载已解压的扩展程序」，选择仓库中的 `extension/` 目录。

3. **调试建议**
   - Background（Service Worker）：使用 `chrome://extensions/` 中的「Service Worker」控制台查看日志、网络请求与 storage 读写。
   - Content Script：在任意页面打开开发者工具，切换到「Sources」或「Console」调试注入的脚本和 DOM。
   - Options 页面：直接在扩展管理页中点击「详情 → 扩展选项」打开，使用常规 web 调试方式。

4. **API 配额与跨域**
   - 新浪与腾讯的行情接口支持 JSONP / 自定义格式，无需额外认证，但需注意在 Manifest 中声明 `host_permissions`。
   - 若后续接入其他行情源，留意请求频率限制，必要时在 Background 中加入退避或批量请求策略。

## 📂 当前目录结构

本仓库已提供一份无需构建步骤的纯原生实现，位于 `extension/` 目录下，直接加载即可使用：

```
.
├── extension/
│   ├── background.js        # Service Worker，统一轮询行情并广播
│   ├── content.css          # 页面悬浮气泡样式
│   ├── content.js           # 注入悬浮气泡、处理拖拽/折叠
│   ├── manifest.json        # Manifest V3 配置
│   ├── options.css          # 配置页样式
│   ├── options.html         # 配置页结构
│   └── options.js           # 配置读取、保存逻辑
├── LICENSE
└── README.md
```

若需要引入打包工具或前端框架，可在此基础上迁移至 `src/` + 构建产物的模式，保持 background/content/options 的职责划分即可。

### 🧪 已实现能力速览

- **双行情源支持**：在选项页可切换「腾讯」或「新浪」接口，后台自动解析相应格式。
- **全局轮询与广播**：Service Worker 统一按配置间隔抓取行情，推送至所有激活标签页并缓存最近一次报价。
- **悬浮气泡交互**：内容脚本创建可拖拽、可折叠、可隐藏的气泡，支持一键刷新与状态持久化。
- **配置页体验**：提供刷新周期、显示模式、气泡尺寸、透明度与主题等选项，保存后即时生效；支持一键重置气泡位置。

接下来可以在现有代码基础上继续扩展多标的、多主题或告警等高级功能。

## 🚀 后续扩展方向

- **多品种支持**：允许在气泡或选项页切换多只股票，或同时展示多个气泡。
- **告警功能**：支持价格触及阈值时通知，或在气泡上给出显著提示。
- **历史趋势**：集成迷你 sparkline 图、成交量柱等可视化元素。
- **快捷交互**：支持键盘快捷键快速隐藏/显示气泡或切换显示模式。
- **跨浏览器移植**：引入 polyfill 适配 Firefox、Edge 等，或利用 `webextension-polyfill`。

---

欢迎提交 Issue / PR 进一步完善功能，也可以将本项目作为自定义行情插件的模板。祝开发愉快！
